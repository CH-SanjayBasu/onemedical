---
title: "One Medical"
author: "Sanjay Basu"
date: "8/15/2019"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

##Import dependencies/packages

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, message = FALSE, cache.lazy = FALSE)
# install.packages('tidyverse', repos = "http://cran.us.r-project.org")
# install.packages('lubridate', repos = "http://cran.us.r-project.org")
# install.packages('readr', repos = "http://cran.us.r-project.org")
# install.packages('stringr', repos = "http://cran.us.r-project.org")
# install.packages('tableone', repos = "http://cran.us.r-project.org")
# install.packages('MatchIt', repos = "http://cran.us.r-project.org")
# install.packages('devtools', repos = "http://cran.us.r-project.org")
# install.packages('stargazer', repos = "http://cran.us.r-project.org")
# install.packages('EValue', repos = "http://cran.us.r-project.org")
# devtools::install_github("healthactuary/cmshcc")
library(tidyverse)
library(lubridate)
library(readr)
library(stringr)
library(tableone)
library(tools)
library(MatchIt)
library(cmshcc)
library(stargazer)
library(EValue)
```

##Import datasets

```{r warning = FALSE, message = FALSE}
setwd("~/Box/Analytics Team/Research/Research projects/One medical")
mbr <- read_csv("spacex_members.csv")
clm <- read_csv("spacex_claims.csv")
rx <- read_csv("spacex_pharmacy.csv")
ctr <- read_csv("SpaceX Health Center Claims 1016 to 1217.csv")
vrt <- read_csv("SpaceX Member Virtual Services 0721919.csv")
feesch <- read_csv("FeesRVU_by_CPT_01_20190723_140220_392625.csv")
```

##Custom functions

```{r cust}

getmode <- function(v) {
   force(v)
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

```

##Format claims to combine CH claims to OM Center claims  

```{r ch plus center}
clm_dol = clm
clm_dol$`Metaclaims Analytics Medical Allowed Amount` = as.numeric(gsub("[\\$,]", "", clm_dol$`Metaclaims Analytics Medical Allowed Amount`))
clm_dol$`Metaclaims Analytics Medical First Name` = str_to_title(clm_dol$`Metaclaims Analytics Medical First Name`)
clm_dol$`Metaclaims Analytics Medical Last Name` = str_to_title(clm_dol$`Metaclaims Analytics Medical Last Name`)

clm_sub = clm_dol %>%
  mutate(personid = (`Metaclaims Analytics Medical Person ID`),
         female = (`Metaclaims Analytics Medical Gender`=="F"),
         firstname = `Metaclaims Analytics Medical First Name`,
         lastname = `Metaclaims Analytics Medical Last Name`,
         pos = `Metaclaims Analytics Medical Service Category Detail`,
         dos = `Metaclaims Analytics Medical Service Date Start Date`,
         om_flag = ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="460695495")&(`Metaclaims Analytics Medical Billing Prov Npi`==1467701821))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="460741732")&(`Metaclaims Analytics Medical Billing Prov Npi`==1073862256))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="362169147")&(`Metaclaims Analytics Medical Billing Prov Npi`==1336709112))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="814542216")&(`Metaclaims Analytics Medical Billing Prov Npi`==1518438712))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="383906267")&(`Metaclaims Analytics Medical Billing Prov Npi`==1528538774))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="471708588")&(`Metaclaims Analytics Medical Billing Prov Npi`==1184014854))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="271346767")&(`Metaclaims Analytics Medical Billing Prov Npi`==1467781641))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="911942315")&(`Metaclaims Analytics Medical Billing Prov Npi`==1073553947))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="812141065")&(`Metaclaims Analytics Medical Billing Prov Npi`==1467800383))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="452282261")&(`Metaclaims Analytics Medical Billing Prov Npi`==1962798645))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="273009385")&(`Metaclaims Analytics Medical Billing Prov Npi`==1861709487))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="812980907")&(`Metaclaims Analytics Medical Billing Prov Npi`==1598214397))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="270243800")&(`Metaclaims Analytics Medical Billing Prov Npi`==1144457151))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="020619758")&(`Metaclaims Analytics Medical Billing Prov Npi`==1497786883))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="461773122")&(`Metaclaims Analytics Medical Billing Prov Npi`==1508103169))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="800925565")&(`Metaclaims Analytics Medical Billing Prov Npi`==1417382102))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="800925565")&(`Metaclaims Analytics Medical Billing Prov Npi`==1922470392)),
         em_flag = ((`Metaclaims Analytics Medical Procedure Code`=='99201')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99202')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99203')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99204')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99205')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99211')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99212')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99213')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99214')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99215'))) %>%
  filter(dos<="2019-07-01") %>%
  group_by(firstname,lastname,female,pos) %>%
  summarise(om_flag = as.logical(getmode(om_flag)),
            em_flag = as.logical(getmode(em_flag)),
            diag1 = getmode(`Metaclaims Analytics Medical Principal Diag`),
            cost_md = sum(`Metaclaims Analytics Medical Allowed Amount`),
            cnt_flag = 0) %>%
  ungroup() 

ctr_sub = ctr
ctr_sub$Name = str_to_title(ctr$Name)
ctr_sub$Name = toTitleCase(ctr$Name)
ctr_sub$`Primary Diagnosis` = as.character(gsub("[\\.]", "", ctr_sub$`Primary Diagnosis`))

ctr_sub = ctr_sub %>%
  separate("Name",c("lastname","empty","firstname"),sep = "([\\, \\ ])", extra="drop", warn = "left") %>%
  mutate(dos = mdy(DOS)) %>%
  group_by(firstname,lastname,Gender,Billing)%>%
  mutate(female= getmode((Gender=='F')),
         om_flag = as.logical(1),
         em_flag = ((CPT=='99201')|
                    (CPT=='99202')|
                    (CPT=='99203')|
                    (CPT=='99204')|
                    (CPT=='99205')|
                    (CPT=='99211')|
                    (CPT=='99212')|
                    (CPT=='99213')|
                    (CPT=='99214')|
                    (CPT=='99215')),
         pt_flag = ((Billing=='KSPANGENBE[109557787]')|
                    (Billing=='MMARCUCCIL[109565213]')),
         mh_flag = ((Billing=='Darling[109701110]')|
                      (Billing=='GFRANK[109571370]')),
         diag1 = getmode(`Primary Diagnosis`),
         pos = ("Office Visits - PCP"))  %>%  
  select(firstname,lastname,female,em_flag,om_flag,diag1,pos,CPT,pt_flag,mh_flag) %>%
  ungroup() 

ctr_sub$pos[ctr_sub$mh_flag==1] = "Mental Health and Substance Use" 
ctr_sub$pos[ctr_sub$pt_flag==1] = "Physical Medicine" 


feesch_sub = feesch %>%
  mutate(cost_md = Fee) %>%
  select(CPT,cost_md)

ctr_sub = full_join(ctr_sub,feesch_sub,by="CPT") %>%  
  select(-CPT) %>%
  mutate(cnt_flag = 1)



```

## OM attribution and utilization counts
  
```{r elig clm}

clm_tot = bind_rows(clm_sub,ctr_sub) 
  
clm_tot = clm_tot %>%
  group_by(firstname, lastname,female) %>%
  filter(any(em_flag==1)) %>%
  summarise(om_flag = getmode(om_flag[em_flag==1]),
            diag1 = getmode(diag1),
            count_drugadmin = sum((pos=="Administered drug inc Chemo")|(pos=="Administration of drug")|(pos=="Immunizations")),
            cost_drugadmin =sum((cost_md[pos=="Administered drug inc Chemo"|pos=="Administration of drug"|(pos=="Immunizations")])),
            count_surg = sum((pos=="Anesthesia")|(pos=="Outpatient Surgery")|(pos=="Surgery")|(pos=="Surgical and Transplant")),
            cost_surg = sum(cost_md[(pos=="Anesthesia")|(pos=="Outpatient Surgery")|(pos=="Surgery")|(pos=="Surgical and Transplant")]),
            count_maternity = sum(pos=="Labor and Delivery" | pos=="Newborns"),
            cost_maternity = sum(cost_md[(pos=="Labor and Delivery" | pos=="Newborns")]),
            count_labs = sum(pos=="Lab Pathology" | pos=="Pathology Lab"),
            cost_labs = sum(cost_md[(pos=="Lab Pathology" | pos=="Pathology Lab")]),
            count_er = sum(pos=="Emergency Room"),
            cost_er = sum(cost_md[pos=="Emergency Room"]),
            count_rads = sum(pos=="Radiology"),
            cost_rads = sum(cost_md[pos=="Radiology"]),
            count_hosp = sum(pos=="Inpatient Visits"|pos=="Medical"),
            cost_hosp = sum(cost_md[pos=="Inpatient Visits"|pos=="Medical"]),
            count_pcp = sum((pos=="Office Visits - PCP")|(pos=="Preventive Visits - PCP")),
            cost_pcp = sum((cost_md[pos=="Office Visits - PCP"|pos=="Preventive Visits - PCP"])),
            count_spec = sum((pos=="Office Visits - Specialist")|(pos=="Preventive Visits - Specialist")),
            cost_spec = sum((cost_md[pos=="Office Visits - Specialist"|pos=="Preventive Visits - Specialist"])),
            count_mh = sum(pos=="Mental Health and Substance Use" | pos=="Psychiatry"),
            cost_mh = sum(cost_md[pos=="Mental Health and Substance Use" | pos=="Psychiatry"]),
            count_pt = sum(pos=="Physical Medicine"),
            cost_pt = sum(cost_md[pos=="Physical Medicine"]),
            cost_other = sum(cost_md[(pos!="Administered drug inc Chemo")|(pos!="Administration of drug")|(pos!="Immunizations")|(pos!="Anesthesia")|(pos!="Outpatient Surgery")|(pos!="Surgery")|(pos!="Surgical and Transplant")|(pos!="Labor and Delivery") | (pos!="Newborns")|(pos!="Lab Pathology") | (pos!="Pathology Lab")|(pos!="Emergency Room")|(pos!="Radiology")|(pos!="Inpatient Visits")|(pos!="Medical")|(pos!="Inpatient Visits")|(pos!="Medical")|(pos!="Office Visits - PCP")|(pos!="Preventive Visits - PCP")|(pos!="Office Visits - Specialist")|(pos!="Preventive Visits - Specialist")|(pos!="Mental Health and Substance Use" | pos!="Psychiatry")|(pos!="Physical Medicine")]),
            cost_md = sum(cost_other+cost_drugadmin+cost_surg+cost_maternity+cost_labs+cost_er+cost_rads+cost_hosp+cost_pcp+cost_spec+cost_mh+cost_pt),
            cnt_flag = max(cnt_flag)) %>%   
  select(firstname,lastname, female,om_flag,diag1,cost_md,count_er,cost_er,count_hosp,cost_hosp,count_pcp,cost_pcp,count_spec,cost_spec,count_mh,cost_mh,count_pt,cost_pt,cnt_flag, count_drugadmin,cost_drugadmin,count_surg,cost_surg,count_maternity,cost_maternity,count_labs,cost_labs,count_rads,cost_rads) %>%
  ungroup()
clm_tot$female[is.na(clm_tot$female)==1]=0



```

##Member org

```{r elig mbr}
mbr_sub = mbr
mbr_sub$`Analytics Member Months First Name` = str_to_title(mbr_sub$`Analytics Member Months First Name`)
mbr_sub$`Analytics Member Months Last Name` = str_to_title(mbr_sub$`Analytics Member Months Last Name`)

mbr_sub = mbr_sub %>%
  mutate(personid = `Analytics Member Months Person ID`) %>%
  group_by(personid) %>%
  mutate(start = min(`Analytics Member Months Start Date`),
         end = max(`Analytics Member Months End Date`),
         age = mean(`Analytics Member Months Age`),
         female = (`Analytics Member Months Gender`=='F'),
         firstname = `Analytics Member Months First Name`,
         lastname = `Analytics Member Months Last Name`,
         membermo = interval(start,end)/months(1),
         DOB = `Analytics Member Months Date of Birth Date`) %>%
  select(age, female, personid, firstname, lastname, membermo, DOB) %>%
  distinct()
```

##Add in pharmacy claims  

```{r elig rx}
rx_dol = rx
rx_dol$`Analytics Claims Pharmacy Allowed Amount` = as.numeric(gsub("[\\$,]", "", rx_dol$`Analytics Claims Pharmacy Allowed Amount`))
rx_dol$`Analytics Claims Pharmacy First Name` = str_to_title(rx_dol$`Analytics Claims Pharmacy First Name`)
rx_dol$`Analytics Claims Pharmacy Last Name` = str_to_title(rx_dol$`Analytics Claims Pharmacy Last Name`)

rx_sub = rx_dol %>%
  mutate(personid = `Analytics Claims Pharmacy Person ID`) %>%
  group_by(personid) %>%
  mutate(female = (`Analytics Claims Pharmacy Gender`=="F"),
         firstname = `Analytics Claims Pharmacy First Name`,
         lastname = `Analytics Claims Pharmacy Last Name`,
         cost_rx = sum(`Analytics Claims Pharmacy Allowed Amount`)) %>%
  select(female, personid, firstname,lastname,cost_rx) %>%
  distinct()
```


##Virtual visits

```{r vrt}
vrt_sub = vrt
vrt_sub$`dphi.patient_first_name` = str_to_title(vrt_sub$`dphi.patient_first_name`)
vrt_sub$`dphi.patient_last_name` = str_to_title(vrt_sub$`dphi.patient_last_name`)

vrt_sub = vrt_sub %>%
  mutate(vrt_flag = 1,
         firstname = dphi.patient_first_name,
         lastname = dphi.patient_last_name) %>%
  select(firstname, lastname, vrt_flag) %>%
  distinct()


```

##HCC risk score

```{r hcc}

spacex_dat = mbr_sub %>% 
  full_join(clm_tot, by = c("firstname","lastname","female")) %>%
  full_join(rx_sub, by = c("firstname","lastname","female")) %>%
  full_join(vrt_sub, by = c("firstname","lastname")) %>%
  mutate(om_flag = replace_na(om_flag,0),
         vrt_flag = replace_na(vrt_flag,0),
         cnt_flag = replace_na(cnt_flag,0)) %>%
  distinct()

PERSON = spacex_dat %>%
  ungroup() %>%
  mutate(HICNO = personid.x,
         SEX = if_else(female==1,"F","M"),
         DOB = DOB,
         MCAID = 0,
         NMCAID = 0,
         OREC = 0) %>%
  select(HICNO, SEX, MCAID, NMCAID, OREC, DOB) %>% 
  filter(!is.na(HICNO))

cmshcc_map <- load_cmshcc_map()

clm <- read_csv("spacex_claims.csv")

clm_hcc  = clm %>%
  mutate(HICNO = (`Metaclaims Analytics Medical Person ID`),
         diag1 = `Metaclaims Analytics Medical Principal Diag`,
         diag2 = `Metaclaims Analytics Medical Diag02`,
         diag3 = `Metaclaims Analytics Medical Diag03`,
         diag4 = `Metaclaims Analytics Medical Diag04`,
         diag5 = `Metaclaims Analytics Medical Diag05`,
         diag6 = `Metaclaims Analytics Medical Diag06`,
         diag7 = `Metaclaims Analytics Medical Diag07`,
         diag8 = `Metaclaims Analytics Medical Diag08`,
         diag9 = `Metaclaims Analytics Medical Diag09`,
         diag10 = `Metaclaims Analytics Medical Diag10`) %>%
  gather(Diag, DX, diag1:diag10, factor_key=T) %>%
  select(HICNO,DX) %>%
  arrange(HICNO)  %>% 
  filter(!is.na(HICNO), !is.na(DX)) %>%
  distinct()

ctr_hcc = ctr
ctr_hcc$Name = str_to_title(ctr$Name)
ctr_hcc$Name = toTitleCase(ctr$Name)

ctr_hcc = ctr_hcc %>%
  separate("Name",c("lastname","empty","firstname"),sep = "([\\, \\ ])", extra="drop", warn = "left") %>%
  mutate(female= getmode((Gender=='F'))) %>%
  separate(`All Diagnosis`, into=c("diag1","diag2","diag3","diag4","diag5","diag6","diag7","diag8","diag9","diag10"), sep = ", ", extra = "drop", warn = "left") %>%
  full_join(mbr_sub, by = c("firstname","lastname","female"))  %>%
  select(personid, diag1, diag2, diag3, diag4, diag5, diag6, diag7, diag8, diag9, diag10)  %>%
  mutate(HICNO= personid) %>%
  gather(Diag, DX, diag1:diag10, factor_key=T) %>%
  select(HICNO,DX) %>%
  arrange(HICNO)  %>% 
  filter(!is.na(HICNO), !is.na(DX)) %>%
  distinct()

DIAG = bind_rows(clm_hcc, ctr_hcc)

hcc = evaluate_v22_2017(PERSON, DIAG, "Community_NonDual_Aged")


```

## CCS cat

```{r ccs}
ccs <- read_csv("ccs_dx_icd10cm_2018_1.csv")
ccs  =ccs %>%
  mutate(diag1 = `ICD-10-CM CODE`,
         ccs = `CCS CATEGORY`) %>%
  select(diag1, ccs)

```

##Pre-match

```{r na}
spacex_dat_ana = mbr_sub %>% 
  full_join(clm_tot, by = c("firstname","lastname","female")) %>%
  full_join(rx_sub, by = c("firstname","lastname","female")) %>%
  full_join(vrt_sub, by = c("firstname","lastname")) %>%
  full_join(hcc, by = c("personid.x" = "HICNO")) %>%
  left_join(ccs, c("diag1")) %>%
  mutate(age = mean(age),
         om_flag = replace_na(om_flag,0),
         vrt_flag = replace_na(vrt_flag,0),
         cnt_flag = replace_na(cnt_flag,0),
         cost_md = replace_na(cost_md,0),
         count_er = replace_na(count_er,0),
         cost_er = replace_na(cost_er,0),
         count_hosp = replace_na(count_hosp,0),
         cost_hosp = replace_na(cost_hosp,0),
         count_pcp = replace_na(count_pcp,0),
         cost_pcp = replace_na(cost_pcp,0),
         count_spec = replace_na(count_spec,0),
         cost_spec = replace_na(cost_spec,0),
         count_mh = replace_na(count_mh,0),
         count_pt = replace_na(count_pt,0),
         cost_pt = replace_na(cost_pt,0),
         cost_mh = replace_na(cost_mh,0),
         cost_rx = replace_na(cost_rx,0),
         count_drugadmin = replace_na(count_drugadmin,0),
         cost_drugadmin = replace_na(cost_drugadmin,0),
         count_surg = replace_na(count_surg,0),
         cost_surg = replace_na(cost_surg,0),
         count_maternity = replace_na(count_maternity,0),
         cost_maternity = replace_na(cost_maternity,0),
         count_labs = replace_na(count_labs,0),
         cost_labs = replace_na(cost_labs, 0),
         count_rads = replace_na(count_rads, 0),
         cost_rads = replace_na(cost_rads,0),
         hcc = Community_NonDual_Aged,
         hcc = replace_na(hcc,0)) %>%
  ungroup() %>%
  group_by(personid.x) %>%
  filter(membermo>0) %>%
  summarise(mm = mean(membermo,na.rm=T),
            age = mean(age, na.rm=TRUE),
            age = replace_na(age,0),
            female = mean(female, na.rm=TRUE),
            female = replace_na(female,0),
            cost_md = (sum(cost_md, na.rm=TRUE)+sum(cost_rx, na.rm=TRUE))/mm, 
            cost_rx = sum(cost_rx, na.rm=TRUE)/mm, 
            cost_er = sum(cost_er, na.rm=TRUE)/mm,
            cost_hosp = sum(cost_hosp, na.rm=TRUE)/mm,
            cost_pcp = sum(cost_pcp, na.rm=TRUE)/mm,
            cost_spec = sum(cost_spec, na.rm=TRUE)/mm,
            cost_mh = sum(cost_mh, na.rm=TRUE)/mm,
            cost_pt = sum(cost_pt, na.rm=TRUE)/mm,
            count_er = sum(count_er, na.rm=TRUE)/mm,
            count_hosp = sum(count_hosp, na.rm=TRUE)/mm,
            count_pcp = sum(count_pcp, na.rm=TRUE)/mm,
            count_spec = sum(count_spec, na.rm=TRUE)/mm,
            count_mh = sum(count_mh, na.rm=TRUE)/mm,
            count_pt = sum(count_pt, na.rm=TRUE)/mm,
            count_drugadmin = sum(count_drugadmin, na.rm=TRUE)/mm,
            cost_drugadmin = sum(cost_drugadmin, na.rm=TRUE)/mm,
            count_surg = sum(count_surg, na.rm=TRUE)/mm,
            cost_surg = sum(cost_surg, na.rm=TRUE)/mm,
            count_maternity = sum(count_maternity, na.rm=TRUE)/mm,
            cost_maternity = sum(cost_maternity, na.rm=TRUE)/mm,
            count_labs = sum(count_labs, na.rm=TRUE)/mm,
            cost_labs = sum(cost_labs, na.rm=TRUE)/mm,
            count_rads = sum(count_rads, na.rm=TRUE)/mm,
            cost_rads = sum(cost_rads, na.rm=TRUE)/mm,
            vrt_flag = mean(vrt_flag,na.rm=T),
            cnt_flag = mean(cnt_flag,na.rm=T),
            om_flag = mean(om_flag, na.rm=T),
            hcc = mean(hcc,na.rm=T),
            ccs = mean(ccs,na.rm=T),
            hcc = replace_na(hcc,0),
            ccs = replace_na(ccs,0),
            ccs = as.factor(ccs),
            diag1 = getmode(`diag1`),
            diag1 = replace_na(diag1,0)) 
  


summary(spacex_dat_ana)


```

##Matching

```{r matching}
spacex_dat_cov <- c('age', 'female', 'mm', 'membermo', 'hcc', 'ccs', 'diag1')

spacex_dat_nomiss = as.data.frame(spacex_dat_ana)

start_time <- Sys.time()

set.seed(1)
mod_match <- matchit(om_flag ~ age + female + ccs + hcc + mm,
                     method = "nearest", data = spacex_dat_nomiss, caliper = .10)
end_time <- Sys.time()

end_time - start_time

mod_match

dta_m <- match.data(mod_match)
dim(dta_m)

dta_m %>%
  group_by(om_flag) %>%
  select(one_of(spacex_dat_cov)) %>%
  summarise_all(funs(mean))

print(CreateTableOne(vars = c("age", "female", "hcc", "mm", "ccs"), strata = "om_flag", data = dta_m, test = T), smd = TRUE, noSpaces = TRUE)

```

#Outcome metrics
```{r outcomes}
dta_run = dta_m %>%
  mutate(logcost_md = log(cost_md+1),
         logcost_er = log(cost_er+1),
         logcost_hosp = log(cost_hosp+1),
         logcost_pcp = log(cost_pcp+1),
         logcost_spec = log(cost_spec+1),
         logcost_mh = log(cost_mh+1),
         logcost_pt = log(cost_pt+1),
         logcost_rx = log(cost_rx+1),
         logcost_drugadmin = log(cost_drugadmin + 1),
         logcost_surg = log(cost_surg+1),
         logcost_maternity = log(cost_maternity+1),
         logcost_labs = log(cost_labs+1),
         logcost_rads = log(cost_rads +1),
        logcount_er = log(count_er+1),
        logcount_hosp = log(count_hosp+1),
        logcount_pcp = log(count_pcp+1),
        logcount_spec = log(count_spec+1),
        logcount_mh = log(count_mh+1),
        logcount_pt = log(count_pt+1),
        logcount_drugadmin = log(count_drugadmin+1),
        logcount_surg = log(count_surg+1),
        logcount_maternity = log(count_maternity+1),
        logcount_labs = log(count_labs+1),
        logcount_rads = log(count_rads+1),
        cost_per_er = log((cost_er+1)/(count_er+1)),
        cost_per_hosp = log((cost_hosp+1)/(count_hosp+1)),
        cost_per_pcp = log((cost_pcp+1)/(count_pcp+1)),
        cost_per_spec = log((cost_spec+1)/(count_spec+1)),
        cost_per_mh = log((cost_mh+1)/(count_mh+1)),
        cost_per_pt = log((cost_pt+1)/(count_pt+1)),
        cost_per_drugadmin = log((cost_drugadmin+1)/(count_drugadmin+1)),
        cost_per_surg = log((cost_surg+1)/(count_surg+1)),
        cost_per_maternity = log((cost_maternity +1)/(count_maternity+1)),
        cost_per_labs = log((cost_labs+1)/(count_labs+1)),
        cost_per_rads = log((cost_rads+1)/(count_rads+1))
        )
```

```{r table 1}
# pre-match
prem = spacex_dat_ana %>%
  mutate(count_er = 1000*count_er,
         count_hosp = 1000*count_hosp,
         count_pcp = 1000*count_pcp,
         count_spec = 1000*count_spec,
         count_mh = 1000*count_mh,
         count_pt = 1000*count_pt,
         count_drugadmin = 1000*count_drugadmin,
         count_surg = 1000*count_surg,
         count_maternity = 1000*count_maternity,
         count_labs = 1000*count_labs,
         count_rads = 1000*count_rads
  )
print(CreateTableOne(data =prem, vars = c("age", "female", "hcc", "mm", "cost_md", "cost_rx", "cost_er" ,"cost_hosp" , "cost_pcp"  , "cost_spec"  ,"cost_mh" ,"cost_pt" ,  "cost_drugadmin","cost_surg","cost_maternity","cost_labs","cost_rads", "count_er"  , "count_hosp" ,"count_pcp" ,"count_spec", "count_mh",   "count_pt"  , "count_drugadmin","count_surg","count_maternity","count_labs","count_rads", "vrt_flag" ,"cnt_flag"), strata="om_flag", test = T), smd = TRUE, contDigits=3, catDigits=3, noSpaces = TRUE)

summary(prem)

# post-match
postm = dta_m %>%
  mutate(count_er = 1000*count_er,
         count_hosp = 1000*count_hosp,
         count_pcp = 1000*count_pcp,
         count_spec = 1000*count_spec,
         count_mh = 1000*count_mh,
         count_pt = 1000*count_pt,
         count_drugadmin = 1000*count_drugadmin,
         count_surg = 1000*count_surg,
         count_maternity = 1000*count_maternity,
         count_labs = 1000*count_labs,
         count_rads = 1000*count_rads
  )

print(CreateTableOne(data =postm, vars = c("age", "female", "hcc", "mm", "cost_md", "cost_rx", "cost_er" ,"cost_hosp" , "cost_pcp"  , "cost_spec"  ,"cost_mh" ,"cost_pt" ,   "cost_drugadmin","cost_surg","cost_maternity","cost_labs","cost_rads","count_er"  , "count_hosp" ,"count_pcp" ,"count_spec", "count_mh",   "count_pt"  , "count_drugadmin","count_surg","count_maternity","count_labs","count_rads", "vrt_flag" ,"cnt_flag"), strata="om_flag", test = F), smd = TRUE, contDigits=3, catDigits=3, noSpaces = TRUE)


summary(postm)

```

#Treatment effect 

```{r ate}

glmMatched1 <- glm(formula = logcost_md ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)

glmMatched2 <- glm(formula = logcost_er ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)

glmMatched3 <- glm(formula = logcost_hosp ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)

glmMatched4 <- glm(formula = logcost_pcp ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)

glmMatched5 <- glm(formula = logcost_spec ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)


glmMatched5a <- glm(formula = logcost_mh ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)


glmMatched5b <- glm(formula = logcost_pt ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)


glmMatched6 <- glm(formula = logcost_rx ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)


glmMatched6a <- glm(formula = logcost_drugadmin ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)
glmMatched6b <- glm(formula = logcost_surg ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)
glmMatched6c <- glm(formula = logcost_maternity ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)
glmMatched6d <- glm(formula = logcost_labs ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)
glmMatched6e <- glm(formula = logcost_rads ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)


glmMatched7 <- glm(formula = logcount_er ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)


glmMatched8 <- glm(formula = logcount_hosp ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)


glmMatched9 <- glm(formula = logcount_pcp ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)

glmMatched10 <- glm(formula = logcount_spec ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)



glmMatched10a <- glm(formula = logcount_mh ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = dta_run)



glmMatched10b <- glm(formula = logcount_pt ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = dta_run)


glmMatched10c <- glm(formula = logcount_drugadmin ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)
glmMatched10d <- glm(formula = logcount_surg ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)
glmMatched10e <- glm(formula = logcount_maternity ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)
glmMatched10f <- glm(formula = logcount_labs ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)
glmMatched10g <- glm(formula = logcount_rads ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)


glmMatched11 <- glm(formula = cost_per_er ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)

glmMatched11b <- glm(formula = cost_per_hosp ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)

glmMatched11c <- glm(formula = cost_per_pcp ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)


glmMatched5c <- glm(formula = cost_per_spec ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = dta_run)


glmMatched5ca <- glm(formula = cost_per_mh ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)


glmMatched5cb <- glm(formula = cost_per_pt ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)



glmMatched5cc <- glm(formula = cost_per_drugadmin ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)

glmMatched5cd <- glm(formula = cost_per_surg ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)

glmMatched5ce <- glm(formula = cost_per_maternity ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)

glmMatched5cf <- glm(formula = cost_per_labs ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)

glmMatched5cg <- glm(formula = cost_per_rads ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = dta_run)


```

##Results as percentage change in each outcome


```{r coef}

exponentiate <- function(x) ((exp(x)-1)*100)

stargazer::stargazer(glmMatched1, glmMatched2, glmMatched3, glmMatched4, glmMatched5, glmMatched5a, glmMatched5b, glmMatched6,glmMatched6a,glmMatched6b,glmMatched6c,glmMatched6d,glmMatched6e,
          title="Spending", 
          type = "text",
          keep=c("om_flag","age","female","mm","hcc"),
          ci=TRUE, ci.level=0.95,
          apply.coef=exponentiate, apply.se = exponentiate,
          digits = 1, 
          star.cutoffs = c(0.05, 0.01, 0.001),
          column.labels = c("Total Spend", "Emergency", "Hospital", "Primary Care", "Specialist", "Mental Health", "Physical Therapy", "Rx", "Drug admin", "Surgery", "Maternity", "Labs", "Radiology"),
          out = "table1.txt")

stargazer::stargazer(glmMatched7, glmMatched8, glmMatched9, glmMatched10, glmMatched10a, glmMatched10b,glmMatched10c,glmMatched10d,glmMatched10e,glmMatched10f,glmMatched10g,
          title="Utilization", 
          type = "text",
          keep=c("om_flag","age","female","mm","hcc"),
          ci=TRUE, ci.level=0.95,
          apply.coef=exponentiate,apply.se = exponentiate,
          digits = 1, 
          star.cutoffs = c(0.05, 0.01, 0.001),
          column.labels = c("Emergency", "Hospital", "Primary Care", "Specialist", "Mental Health", "Physical Therapy", "Drug admin", "Surgery", "Maternity", "Labs", "Radiology"),
          out = "table2.txt")

stargazer::stargazer(glmMatched11, glmMatched11b, glmMatched11c, glmMatched5c, glmMatched5ca, glmMatched5cb,  glmMatched5cc,  glmMatched5cd,  glmMatched5ce,  glmMatched5cf,  glmMatched5cg, 
          title="Cost per Utilization", 
          type = "text",
          keep=c("om_flag","age","female","mm","hcc"),
          ci=TRUE, ci.level=0.95,
          apply.coef=exponentiate,apply.se = exponentiate,
          digits = 1, 
          star.cutoffs = c(0.05, 0.01, 0.001),
          column.labels = c("Emergency", "Hospital", "Primary Care", "Specialist", "Mental Health", "Physical Therapy", "Drug admin", "Surgery", "Maternity", "Labs", "Radiology"),
          out = "table3.txt")

evalues.OLS(est = glmMatched1$coefficients[2],
se = summary(glmMatched1)$coefficients['om_flag','Std. Error'],
sd = sd(dta_run$logcost_md) )




```


#Sensitivity analyses:
- exclude NICU and newborns, dialysis, pregnancy, hospice, rehab, and transplants
- cap claimants to $50k/12mo
- exclude those without a min # of member-months: 12


```{r sens1}

sens_m = dta_run %>%
  filter(age != 0,
         diag1 != "Z992",
         diag1 != "Z340",
         diag1 != "Z515",
         diag1 != "F0",
         diag1 != "T86",
         (cost_md/mm) < (50000/12),
         mm>12) 
```

#Sensitivity results 

```{r ate1}

glmMatched1_s <- glm(formula = logcost_md ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = sens_m)

glmMatched2_s <- glm(formula = logcost_er ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = sens_m)

glmMatched3_s <- glm(formula = logcost_hosp ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = sens_m)

glmMatched4_s <- glm(formula = logcost_pcp ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = sens_m)

glmMatched5_s <- glm(formula = logcost_spec ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = sens_m)


glmMatched5a_s <- glm(formula = logcost_mh ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = sens_m)


glmMatched5b_s <- glm(formula = logcost_pt ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = sens_m)


glmMatched6_s <- glm(formula = logcost_rx ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = sens_m)


glmMatched6a_s <- glm(formula = logcost_drugadmin ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = sens_m)
glmMatched6b_s <- glm(formula = logcost_surg ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = sens_m)
glmMatched6c_s <- glm(formula = logcost_maternity ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = sens_m)
glmMatched6d_s <- glm(formula = logcost_labs ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = sens_m)
glmMatched6e_s <- glm(formula = logcost_rads ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = sens_m)


glmMatched7_s <- glm(formula = logcount_er ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = sens_m)


glmMatched8_s <- glm(formula = logcount_hosp ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = sens_m)


glmMatched9_s <- glm(formula = logcount_pcp ~ om_flag + age + female + mm + hcc + ccs ,
                   data    = sens_m)

glmMatched10_s <- glm(formula = logcount_spec ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = sens_m)



glmMatched10a_s <- glm(formula = logcount_mh ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)



glmMatched10b_s <- glm(formula = logcount_pt ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)


glmMatched10c_s <- glm(formula = logcount_drugadmin ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)
glmMatched10d_s <- glm(formula = logcount_surg ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)
glmMatched10e_s <- glm(formula = logcount_maternity ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)
glmMatched10f_s <- glm(formula = logcount_labs ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)
glmMatched10g_s <- glm(formula = logcount_rads ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)


glmMatched11_s <- glm(formula = cost_per_er ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = sens_m)

glmMatched11b_s <- glm(formula = cost_per_hosp ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)

glmMatched11c_s <- glm(formula = cost_per_pcp ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)


glmMatched5c_s <- glm(formula = cost_per_spec ~ om_flag + age + female + mm + hcc + ccs ,
                    data    = sens_m)


glmMatched5ca_s <- glm(formula = cost_per_mh ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)


glmMatched5cb_s <- glm(formula = cost_per_pt ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)



glmMatched5cc_s <- glm(formula = cost_per_drugadmin ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)

glmMatched5cd_s <- glm(formula = cost_per_surg ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)

glmMatched5ce_s <- glm(formula = cost_per_maternity ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)

glmMatched5cf_s <- glm(formula = cost_per_labs ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)

glmMatched5cg_s <- glm(formula = cost_per_rads ~ om_flag + age + female + mm + hcc + ccs ,
                     data    = sens_m)


```

#Sens table results 


```{r coef1}

exponentiate_s <- function(x) ((exp(x)-1)*100)

stargazer::stargazer(glmMatched1_s, glmMatched2_s, glmMatched3_s, glmMatched4_s, glmMatched5_s, glmMatched5a_s, glmMatched5b_s, glmMatched6,glmMatched6a,glmMatched6b,glmMatched6c,glmMatched6d,glmMatched6e,
          title="Spending", 
          type = "text",
          keep=c("om_flag","age","female","mm","hcc"),
          ci=TRUE, ci.level=0.95,
          apply.coef=exponentiate, apply.se = exponentiate,
          digits = 1, 
          star.cutoffs = c(0.05, 0.01, 0.001),
          column.labels = c("Total Spend", "Emergency", "Hospital", "Primary Care", "Specialist", "Mental Health", "Physical Therapy", "Rx", "Drug admin", "Surgery", "Maternity", "Labs", "Radiology"),
          out = "table1s.txt")

stargazer::stargazer(glmMatched7_s, glmMatched8_s, glmMatched9_s, glmMatched10_s, glmMatched10a_s, glmMatched10b,glmMatched10c,glmMatched10d,glmMatched10e,glmMatched10f,glmMatched10g,
          title="Utilization", 
          type = "text",
          keep=c("om_flag","age","female","mm","hcc"),
          ci=TRUE, ci.level=0.95,
          apply.coef=exponentiate,apply.se = exponentiate,
          digits = 1, 
          star.cutoffs = c(0.05, 0.01, 0.001),
          column.labels = c("Emergency", "Hospital", "Primary Care", "Specialist", "Mental Health", "Physical Therapy", "Drug admin", "Surgery", "Maternity", "Labs", "Radiology"),
          out = "table2s.txt")

stargazer::stargazer(glmMatched11_s, glmMatched11b_s, glmMatched11c_s, glmMatched5c_s, glmMatched5ca_s, glmMatched5cb,  glmMatched5cc,  glmMatched5cd,  glmMatched5ce,  glmMatched5cf,  glmMatched5cg, 
          title="Cost per Utilization", 
          type = "text",
          keep=c("om_flag","age","female","mm","hcc"),
          ci=TRUE, ci.level=0.95,
          apply.coef=exponentiate,apply.se = exponentiate,
          digits = 1, 
          star.cutoffs = c(0.05, 0.01, 0.001),
          column.labels = c("Emergency", "Hospital", "Primary Care", "Specialist", "Mental Health", "Physical Therapy", "Drug admin", "Surgery", "Maternity", "Labs", "Radiology"),
          out = "table3s.txt")

save.image("~/Box/Analytics Team/Research/Research projects/One medical/onemedical.RData")


```

