---
title: "One Medical"
author: "Sanjay Basu"
date: "7/2/2019"
output: pdf_document
---

##Import dependencies/packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages('dplyr')
install.packages('readr')
install.packages('tableone')
library(dplyr)
library(readr)
library(tableone)
```

##Import datasets

SpaceX members, medical claims, and pharmacy claims

```{r warning = FALSE, message = FALSE}
setwd("~/Box/Analytics Team/Research/Research projects/One medical")
mbr <- read_csv("spacex_members.csv")
clm <- read_csv("spacex_claims.csv")
rx <- read_csv("spacex_pharmacy.csv")
```


##Member org

Reorganize member data to enable eligibility criteria application
requirement of continuous enrollment 

```{r elig mbr}
mbr_sub = mbr %>%
  mutate(personid = `Analytics Member Months Person ID`) %>%
  group_by(personid) %>%
  mutate(start = min(`Analytics Member Months Start Date`),
         end = max(`Analytics Member Months End Date`),
         age = mean(`Analytics Member Months Age`),
         female = (`Analytics Member Months Gender`=='F')) %>%
  filter(start=="2016-01-01",
         end=="2019-12-31") %>%
  select(age, female, personid) %>%
  distinct()
```

##Recode claims $ values

remove dollar signs and commas from dollar amounts in the claims data

```{r $ recode clm}
clm_dol = clm
clm_dol$`Metaclaims Analytics Medical Paid Amount Ch` = as.numeric(gsub("[\\$,]", "", clm_dol$`Metaclaims Analytics Medical Paid Amount Ch`))
clm_dol$`Metaclaims Analytics Medical Copay Amount` = as.numeric(gsub("[\\$,]", "", clm_dol$`Metaclaims Analytics Medical Copay Amount`))
clm_dol$`Metaclaims Analytics Medical Coinsurance Amount` = as.numeric(gsub("[\\$,]", "", clm_dol$`Metaclaims Analytics Medical Coinsurance Amount`))
clm_dol$`Metaclaims Analytics Medical Deductible Amount` = as.numeric(gsub("[\\$,]", "", clm_dol$`Metaclaims Analytics Medical Deductible Amount`))
```

##Inclusion criteria application

Unique combination of NPI / Tax ID should be used to identify OM claims 
Inclusion criteria: E&M visit from any provider 
OM attribution:
- Most Evaluation and Management (E&M) Visits – The highest percentage of primary care E&M visits
- E&Ms included: 99201 – 99205, 99211 - 99215
    
```{r elig clm}
getmode <- function(v) {
   force(v)
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

clm_sub = clm_dol %>%
  mutate(personid = (`Metaclaims Analytics Medical Person ID`),
         om_flag = ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="460695495")&(`Metaclaims Analytics Medical Billing Prov Npi`==1467701821))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="460741732")&(`Metaclaims Analytics Medical Billing Prov Npi`==1073862256))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="362169147")&(`Metaclaims Analytics Medical Billing Prov Npi`==1336709112))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="814542216")&(`Metaclaims Analytics Medical Billing Prov Npi`==1518438712))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="383906267")&(`Metaclaims Analytics Medical Billing Prov Npi`==1528538774))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="471708588")&(`Metaclaims Analytics Medical Billing Prov Npi`==1184014854))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="271346767")&(`Metaclaims Analytics Medical Billing Prov Npi`==1467781641))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="911942315")&(`Metaclaims Analytics Medical Billing Prov Npi`==1073553947))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="812141065")&(`Metaclaims Analytics Medical Billing Prov Npi`==1467800383))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="452282261")&(`Metaclaims Analytics Medical Billing Prov Npi`==1962798645))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="273009385")&(`Metaclaims Analytics Medical Billing Prov Npi`==1861709487))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="812980907")&(`Metaclaims Analytics Medical Billing Prov Npi`==1598214397))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="270243800")&(`Metaclaims Analytics Medical Billing Prov Npi`==1144457151))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="020619758")&(`Metaclaims Analytics Medical Billing Prov Npi`==1497786883))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="461773122")&(`Metaclaims Analytics Medical Billing Prov Npi`==1508103169))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="800925565")&(`Metaclaims Analytics Medical Billing Prov Npi`==1417382102))|
                   ((`Metaclaims Analytics Medical Billing Prov Bill ID`=="800925565")&(`Metaclaims Analytics Medical Billing Prov Npi`==1922470392)),
         em_flag = ((`Metaclaims Analytics Medical Procedure Code`=='99201')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99202')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99203')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99204')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99205')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99211')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99212')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99213')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99214')|
                    (`Metaclaims Analytics Medical Procedure Code`=='99215'))) %>%
  group_by(personid) %>%
  filter(any(em_flag==1)) %>%
  summarise(om_flag = getmode(om_flag[em_flag==1]),
            diag1 = getmode(`Metaclaims Analytics Medical Diag01`),
            cost_md = sum(`Metaclaims Analytics Medical Paid Amount Ch`),
            copay_md = sum(`Metaclaims Analytics Medical Copay Amount`),
            coins_md = sum(`Metaclaims Analytics Medical Coinsurance Amount`),
            deduct_md = sum(`Metaclaims Analytics Medical Deductible Amount`),
            count_er = sum(`Metaclaims Analytics Medical Service Category Detail Ch`=="Emergency Room"),
            cost_er = sum(`Metaclaims Analytics Medical Paid Amount Ch`[`Metaclaims Analytics Medical Service Category Detail Ch`=="Emergency Room"]),
            count_hosp = sum(`Metaclaims Analytics Medical Service Category Detail Ch`=="Inpatient Visits"),
            cost_hosp = sum(`Metaclaims Analytics Medical Paid Amount Ch`[`Metaclaims Analytics Medical Service Category Detail Ch`=="Inpatient Visits"]),
            count_pcp = sum((`Metaclaims Analytics Medical Service Category Detail Ch`=="Office Visits - PCP")|(`Metaclaims Analytics Medical Service Category Detail Ch`=="Preventive Visits - PCP")),
            cost_pcp = sum((`Metaclaims Analytics Medical Paid Amount Ch`[`Metaclaims Analytics Medical Service Category Detail Ch`=="Office Visits - PCP"|`Metaclaims Analytics Medical Service Category Detail Ch`=="Preventive Visits - PCP"])),
            count_spec = sum((`Metaclaims Analytics Medical Service Category Detail Ch`=="Office Visits - Specialist")|(`Metaclaims Analytics Medical Service Category Detail Ch`=="Preventive Visits - Specialist")),
            cost_spec = sum((`Metaclaims Analytics Medical Paid Amount Ch`[`Metaclaims Analytics Medical Service Category Detail Ch`=="Office Visits - Specialist"|`Metaclaims Analytics Medical Service Category Detail Ch`=="Preventive Visits - Specialist"]))) %>%
  select(personid,om_flag,diag1,cost_md,copay_md,coins_md,deduct_md,count_er,cost_er,count_hosp,cost_hosp,count_pcp,cost_pcp,count_spec,cost_spec) %>%
  distinct()
```

##Pharmacy claims org

```{r elig rx}
rx_dol = rx
rx_dol$`Analytics Claims Pharmacy Paid Amount` = as.numeric(gsub("[\\$,]", "", rx_dol$`Analytics Claims Pharmacy Paid Amount`))
rx_dol$`Analytics Claims Pharmacy Copay Amount` = as.numeric(gsub("[\\$,]", "", rx_dol$`Analytics Claims Pharmacy Copay Amount`))
rx_dol$`Analytics Claims Pharmacy Coinsurance Amount` = as.numeric(gsub("[\\$,]", "", rx_dol$`Analytics Claims Pharmacy Coinsurance Amount`))
rx_dol$`Analytics Claims Pharmacy Deductible Amount` = as.numeric(gsub("[\\$,]", "", rx_dol$`Analytics Claims Pharmacy Deductible Amount`))
rx_sub = rx_dol %>%
  mutate(personid = `Analytics Claims Pharmacy Person ID`) %>%
  group_by(personid) %>%
  mutate(cost_rx = sum(`Analytics Claims Pharmacy Paid Amount`),
         copay_rx = sum(`Analytics Claims Pharmacy Copay Amount`),
         coins_rx = sum(`Analytics Claims Pharmacy Coinsurance Amount`),
         deduct_rx = sum(`Analytics Claims Pharmacy Deductible Amount`)) %>%
  select(personid,cost_rx,copay_rx,coins_rx,deduct_rx) %>%
  distinct()
```

##Merge data

by person id, left joining to isolate to eligible mbrs only

```{r merge}
spacex_dat = mbr_sub %>%
  left_join(clm_sub, by="personid") %>%
  left_join(rx_sub, by = "personid")

CreateTableOne(vars = c("age", "female",  "cost_md", "copay_md", "coins_md", "deduct_md","count_er","cost_er","count_hosp","cost_hosp","count_pcp","cost_pcp","count_spec","cost_spec", "cost_rx", "copay_rx", "coins_rx", "deduct_rx"), strata = "om_flag" , data = spacex_dat, factorVars = c("female", "om_flag", "diag1"))
```

## Base key outcome variables vs. control
PEPM by service type 
Utilization rates by service type
Episode-based cost analyses for MH and PT

```{r outcome prematch}
spacex_dat = spacex_dat %>%
  mutate(pepm_medprx = sum(cost_md+cost_rx)/length(mbr_sub)/42, #42 months in current claims set
         pepm_er = sum(cost_er)/length(mbr_sub)/42,
         pepm_hosp = sum(cost_hosp)/length(mbr_sub)/42,
         pepm_pcp = sum(cost_pcp)/length(mbr_sub)/42,
         pepm_spec = sum(cost_spec)/length(mbr_sub)/42,
         util_er = sum(count_er)/length(mbr_sub)/42*1000,
         util_hosp = sum(count_hosp)/length(mbr_sub)/42*1000,
         util_pcp = sum(count_pcp)/length(mbr_sub)/42*1000,
         util_spec = sum(count_spec)/length(mbr_sub)/42*1000,
         cost_per_er = sum(cost_er)/sum(count_er),
         cost_per_hosp = sum(cost_hosp)/sum(count_hosp),
         cost_per_pcp = sum(cost_pcp)/sum(count_pcp),
         cost_per_spec = sum(cost_spec)/sum(count_spec))

CreateTableOne(vars = c("age", "female",  "cost_md", "copay_md", "coins_md", "deduct_md","count_er","cost_er","cost_hosp","count_pcp","count_spec","cost_spec", "cost_rx", "copay_rx", "coins_rx", "deduct_rx", "pepm_medprx", "pepm_er", "pepm_hosp", "pepm_pcp", "pepm_spec", "util_er", "util_hosp", "util_pcp", "util_spec", "cost_per_er", "cost_per_hosp", "cost_per_pcp", "cost_per_spec"), strata = "om_flag" , data = spacex_dat, factorVars = c("female", "om_flag", "diag1"))

```


##Matching

coarsened exact match on all features

```{r matching}

```
